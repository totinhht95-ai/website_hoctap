{% extends "base.html" %}

{% block title %}Chatbot AI - H·ªçc Tin THPT{% endblock %}

{% block content %}
<div class="container">
    <h1>ü§ñ Chatbot AI - Tr·ª£ l√Ω h·ªçc t·∫≠p</h1>
    <p class="subtitle">H·ªèi ƒë√°p v·ªõi AI Gemini v·ªÅ Tin h·ªçc THPT</p>

    <div class="chatbot-container">
        <!-- Khung chat -->
        <div class="chat-box" id="chatBox">
            <div class="message bot-message">
                <strong>AI Assistant:</strong>
                <p>Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i b·∫•t k·ª≥ c√¢u h·ªèi n√†o v·ªÅ Tin h·ªçc THPT. üòä</p>
            </div>
        </div>

        <!-- Form nh·∫≠p tin nh·∫Øn -->
        <div class="chat-input-container">
            <form id="chatForm" onsubmit="sendMessage(event)">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." 
                    autocomplete="off"
                    required
                >
                <button type="submit" class="btn btn-primary">G·ª≠i</button>
            </form>
        </div>

        <!-- G·ª£i √Ω c√¢u h·ªèi -->
        <div class="suggestions">
            <p><strong>G·ª£i √Ω c√¢u h·ªèi:</strong></p>
            <button onclick="quickQuestion('Gi·∫£i th√≠ch v√≤ng l·∫∑p for trong Python')" class="suggestion-btn">
                V√≤ng l·∫∑p for trong Python
            </button>
            <button onclick="quickQuestion('S·ª± kh√°c bi·ªát gi·ªØa list v√† tuple')" class="suggestion-btn">
                List vs Tuple
            </button>
            <button onclick="quickQuestion('C·∫•u tr√∫c d·ªØ li·ªáu Stack l√† g√¨?')" class="suggestion-btn">
                Stack l√† g√¨?
            </button>
        </div>
    </div>
</div>

<script>
async function sendMessage(event) {
    event.preventDefault();
    
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
    addMessage(message, 'user');
    input.value = '';
    
    // Hi·ªÉn th·ªã loading
    const loadingId = addMessage('ƒêang suy nghƒ©...', 'bot', true);
    
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: message})
        });
        
        const data = await response.json();
        
        // X√≥a loading v√† hi·ªÉn th·ªã k·∫øt qu·∫£
        removeMessage(loadingId);
        addMessage(data.response, 'bot');
        
    } catch (error) {
        removeMessage(loadingId);
        addMessage('Xin l·ªói, c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!', 'bot');
        console.error('Error:', error);
    }
}

function addMessage(text, sender, isLoading = false) {
    const chatBox = document.getElementById('chatBox');
    const messageDiv = document.createElement('div');
    const messageId = 'msg-' + Date.now();
    
    messageDiv.id = messageId;
    messageDiv.className = `message ${sender}-message ${isLoading ? 'loading' : ''}`;
    
    if (sender === 'user') {
        messageDiv.innerHTML = `<strong>B·∫°n:</strong><p>${text}</p>`;
    } else {
        messageDiv.innerHTML = `<strong>AI Assistant:</strong><p>${text}</p>`;
    }
    
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    return messageId;
}

function removeMessage(messageId) {
    const message = document.getElementById(messageId);
    if (message) {
        message.remove();
    }
}

function quickQuestion(question) {
    document.getElementById('messageInput').value = question;
    document.getElementById('chatForm').dispatchEvent(new Event('submit'));
}
</script>

<style>
.chatbot-container {
    max-width: 800px;
    margin: 0 auto;
}

.chat-box {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    height: 500px;
    overflow-y: auto;
    background-color: #f9f9f9;
    margin-bottom: 20px;
}

.message {
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 8px;
}

.user-message {
    background-color: #007bff;
    color: white;
    text-align: right;
    margin-left: 20%;
}

.bot-message {
    background-color: white;
    border: 1px solid #ddd;
    margin-right: 20%;
}

.loading {
    opacity: 0.6;
    font-style: italic;
}

.chat-input-container form {
    display: flex;
    gap: 10px;
}

.chat-input-container input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.suggestions {
    margin-top: 20px;
    padding: 15px;
    background-color: #f0f0f0;
    border-radius: 8px;
}

.suggestion-btn {
    display: inline-block;
    margin: 5px;
    padding: 8px 15px;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s;
}

.suggestion-btn:hover {
    background-color: #007bff;
    color: white;
}
</style>
{% endblock %}